<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/health.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        {% include '_sidebar.html' %}
        <div class="main-content">
            <div class="header"><h1>Health</h1><div class="header-actions"><button id="addHealthRecordBtn"><i class="fas fa-plus"></i> Add Record</button></div></div>
            {% with messages = get_flashed_messages(with_categories=true) %}{% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }}">{{ message }}</div>{% endfor %}{% endif %}{% endwith %}
            <div class="health-layout">
                <div class="health-card"><div class="card-header"><h2 class="card-title">Basic Health Information</h2></div><form id="profileForm" action="{{ url_for('update_profile') }}" method="POST"><div class="basic-info-form"><div class="form-group"><label>Weight (kg)</label><input type="number" value="{{ '%.1f'|format(latest_record.weight) if latest_record else '' }}" disabled></div><div class="form-group"><label for="height">Height (cm)</label><input type="number" name="height" value="{{ profile.height or '' }}" min="50" max="250"></div><div class="form-group"><label for="age">Age</label><input type="number" name="age" value="{{ profile.age or '' }}" min="13" max="100"></div><div class="form-group"><label for="gender">Gender</label><select name="gender"><option value="Male" {% if profile.gender == 'Male' %}selected{% endif %}>Male</option><option value="Female" {% if profile.gender == 'Female' %}selected{% endif %}>Female</option><option value="Other" {% if profile.gender == 'Other' %}selected{% endif %}>Other</option></select></div></div><div class="form-buttons"><button type="submit" class="form-btn save">Save Profile</button></div></form><div class="health-stats"><div class="stat-card"><div class="stat-label">Current Weight</div><div class="stat-value weight">{{ '%.1f'|format(latest_record.weight) if latest_record else 'N/A' }}kg</div><div class="stat-label">Last updated: {{ latest_record.date.strftime('%b %d') if latest_record else 'N/A' }}</div></div><div class="stat-card"><div class="stat-label">Height</div><div class="stat-value height">{{ '%.0f'|format(profile.height) if profile.height else 'N/A' }}cm</div><div class="stat-label">BMI: {{ bmi if bmi else 'N/A' }}</div></div><div class="stat-card"><div class="stat-label">Body Fat</div><div class="stat-value bmi">{{ '%.1f'|format(latest_record.body_fat) if latest_record and latest_record.body_fat else 'N/A' }}%</div><div class="stat-label">Measured: {{ latest_record.date.strftime('%b %d') if latest_record else 'N/A' }}</div></div></div></div>
                <div class="health-card">
                    <div class="charts-section">
                        <!-- NEW: Chart Header with Toggle Buttons -->
                        <div class="chart-header">
                            <h3 class="chart-title" style="margin-bottom: 0;">Weight Progress</h3>
                            <div class="chart-toggle-buttons">
                                <button class="chart-toggle-btn active" id="lineChartBtn">Line</button>
                                <button class="chart-toggle-btn" id="barChartBtn">Bar</button>
                            </div>
                        </div>
                        <div class="chart-container"><canvas id="healthChart"></canvas></div>
                    </div>
                    <div class="calendar-section"><h3 class="chart-title">Measurement Calendar</h3><div class="calendar-grid" id="measurementCalendar">{% for day in range(1, 32) %}<div class="calendar-day {% if day == current_day %}today{% endif %} {% if day|string in measured_days %}measured{% endif %}">{{ day }}</div>{% endfor %}</div></div>
                </div>
            </div>
            <div class="health-card" style="margin-bottom: 30px;"><div class="card-header"><h2 class="card-title">Health Records History</h2></div><table class="history-table"><thead><tr><th>Date</th><th>Weight</th><th>Body Fat</th><th class="notes-column">Notes</th><th class="actions-column">Actions</th></tr></thead><tbody>{% for record in all_health_records %}<tr><td>{{ record.date.strftime('%Y-%m-%d') }}</td><td>{{ '%.1f'|format(record.weight) if record.weight else 'N/A' }} kg</td><td>{{ '%.1f'|format(record.body_fat) if record.body_fat else 'N/A' }} %</td><td class="notes-column" title="{{ record.notes }}">{{ record.notes or '...' }}</td><td class="actions-column"><div class="plan-item-actions"><a href="{{ url_for('edit_health_record', record_id=record.id) }}" class="plan-action-btn"><i class="fas fa-edit"></i></a><form action="{{ url_for('delete_health_record', record_id=record.id) }}" method="POST" onsubmit="return confirm('Delete this record?')"><button type="submit" class="plan-action-btn delete"><i class="fas fa-trash"></i></button></form></div></td></tr>{% else %}<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">No health records found.</td></tr>{% endfor %}</tbody></table></div>
            <div class="health-card"><div class="card-header"><h2 class="card-title">Health Plan</h2><button id="addPlanItemBtn" class="form-btn save" style="padding: 8px 15px;"><i class="fas fa-plus"></i> Add Item</button></div><div class="health-plan"><div class="plan-items">{% for item in health_plan_items %}<div class="plan-item {% if item.status == 'completed' %}completed{% endif %}"><div class="plan-item-content"><h4>{{ item.title }}</h4><p>{{ item.description }}</p></div><div class="plan-item-actions"><form action="{{ url_for('toggle_health_plan_item', item_id=item.id) }}" method="POST"><button type="submit" class="plan-action-btn complete"><i class="fas fa-{% if item.status == 'completed' %}undo{% else %}check{% endif %}"></i></button></form><a href="{{ url_for('edit_health_plan_item', item_id=item.id) }}" class="plan-action-btn"><i class="fas fa-edit"></i></a><form action="{{ url_for('delete_health_plan_item', item_id=item.id) }}" method="POST" onsubmit="return confirm('Delete this plan item?')"><button type="submit" class="plan-action-btn delete"><i class="fas fa-trash"></i></button></form></div></div>{% else %}<p style="color: var(--text-secondary);">No health plan items found. Click 'Add Item' to create one.</p>{% endfor %}</div></div></div>
            <div class="health-card export-section" style="margin-top: 30px;"><a href="{{ url_for('export_health_data') }}" class="export-btn"><i class="fas fa-file-download"></i> Export Health Data</a></div>
        </div>
    </div>
    <div id="addRecordModal" class="modal">...</div><div id="addPlanItemModal" class="modal">...</div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('healthChart').getContext('2d');
            const chartLabels = JSON.parse('{{ chart_labels | safe }}');
            const chartData = JSON.parse('{{ chart_data | safe }}');
            let myChart;

            // --- Define Chart Configurations ---
            const lineChartConfig = {
                type: 'line',
                data: { labels: chartLabels, datasets: [{ label: 'Weight (kg)', data: chartData, borderColor: 'rgba(255, 107, 53, 1)', backgroundColor: 'rgba(255, 107, 53, 0.2)', fill: true, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: true, ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' } }, x: { display: true, ticks: { color: 'var(--text-secondary)' }, grid: { color: 'var(--border-color)' } } }, plugins: { legend: { display: false } } }
            };

            const barChartConfig = {
                type: 'bar',
                data: { labels: chartLabels, datasets: [{ label: 'Weight (kg)', data: chartData,
                    backgroundColor: (context) => {
                        const chart = context.chart;
                        const {ctx, chartArea} = chart;
                        if (!chartArea) { return null; }
                        const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                        gradient.addColorStop(0, 'rgba(255, 107, 53, 1)'); // var(--primary)
                        gradient.addColorStop(1, 'rgba(116, 185, 255, 1)'); // var(--accent)
                        return gradient;
                    },
                    borderRadius: 5
                }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { display: false } }, plugins: { legend: { display: false }, tooltip: { displayColors: false } } }
            };

            // --- Chart Rendering and Toggling Logic ---
            const lineChartBtn = document.getElementById('lineChartBtn');
            const barChartBtn = document.getElementById('barChartBtn');
            
            function renderChart(config) {
                if (myChart) { myChart.destroy(); }
                myChart = new Chart(ctx, config);
            }

            lineChartBtn.addEventListener('click', () => {
                renderChart(lineChartConfig);
                lineChartBtn.classList.add('active');
                barChartBtn.classList.remove('active');
            });

            barChartBtn.addEventListener('click', () => {
                renderChart(barChartConfig);
                barChartBtn.classList.add('active');
                lineChartBtn.classList.remove('active');
            });

            // Initial render
            renderChart(lineChartConfig);

            // --- Interactive Calendar and Modal Logic (unchanged) ---
            const recordsByDate = JSON.parse('{{ records_by_date_json | safe }}');const calendarGrid = document.getElementById('measurementCalendar');calendarGrid.addEventListener('click', function(e) {const dayElement = e.target.closest('.calendar-day');if (!dayElement) return;const day = dayElement.textContent.trim();if (dayElement.classList.contains('measured')) {const record = recordsByDate[day];if (record) {let alertMessage = `Measurement for day ${day}:\n---------------------------\nWeight: ${record.weight || 'N/A'} kg\nBody Fat: ${record.body_fat || 'N/A'} %\nNotes: ${record.notes || 'No notes'}`;alert(alertMessage);}} else {alert(`No measurement recorded for day ${day}.`);}});function setupModal(triggerId, modalId) {const modal = document.getElementById(modalId);if (!modal) return;const trigger = document.getElementById(triggerId);if (trigger) {trigger.addEventListener('click', () => {modal.style.display = 'flex';});}const closeModal = () => {modal.style.display = 'none';};modal.querySelectorAll('.close-modal, .form-btn.cancel').forEach(btn => btn.addEventListener('click', closeModal));modal.addEventListener('click', e => {if (e.target === modal) closeModal();});}setupModal('addHealthRecordBtn', 'addRecordModal');setupModal('addPlanItemBtn', 'addPlanItemModal');document.getElementById('addHealthRecordBtn').addEventListener('click', () => {document.querySelector('#addRecordModal input[name="date"]').value = new Date().toISOString().split('T')[0];});
        });
    </script>
</body>
</html>
