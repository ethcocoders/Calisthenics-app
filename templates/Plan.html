<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/plan.css') }}">
</head>
<body>
    <div class="container">
        {% include '_sidebar.html' %}
        <div class="main-content">
            <div class="header">
                <h1>Plan</h1>
                <div class="header-actions">
                    <button id="addPlanBtn"><i class="fas fa-plus"></i> Add Plan</button>
                </div>
            </div>
            {% with messages = get_flashed_messages(with_categories=true) %}{% if messages %}{% for category, message in messages %}<div class="alert alert-{{ category }}">{{ message }}</div>{% endfor %}{% endif %}{% endwith %}

            <div class="plan-layout">
                <div class="plan-card">
                    <div class="card-header"><h2 class="card-title">Plan Overview</h2></div>
                    <div class="plan-stats"><div class="stat-card"><div class="stat-label">Total Plans</div><div class="stat-value total">{{ total_plans }}</div><div class="stat-label">Active Plans</div></div><div class="stat-card"><div class="stat-label">Completed</div><div class="stat-value completed">{{ completed_plans }}</div><div class="stat-label">This Month</div></div><div class="stat-card"><div class="stat-label">Pending</div><div class="stat-value pending">{{ pending_plans }}</div><div class="stat-label">Upcoming</div></div></div>
                    <div class="progress-section"><h3 class="progress-title">Monthly Progress</h3><div class="progress-bar"><div class="progress-fill" style="width: {{ completion_percentage }}%;"></div></div><div class="progress-info"><span>{{ completion_percentage }}% Completed</span><span>{{ completed_plans }}/{{ total_plans }} plans</span></div></div>
                    
                    <div class="timeline-chart">
                        <h3 class="progress-title">Plan Timeline</h3>
                        <div class="timeline-container" id="timelineContainer">
                            <!-- Timeline points are generated by JavaScript -->
                        </div>
                    </div>
                    <div class="calendar-integration">
                        <h3 class="progress-title">Plan Calendar (Current Month)</h3>
                        <div class="calendar-grid" id="planCalendarGrid">
                            <!-- Calendar days are generated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="plan-card">
                    <div class="card-header"><h2 class="card-title">Plan Details</h2></div>
                    <div class="plan-cards"><div class="cards-grid">
                        {% for plan in all_plans %}
                        <div class="plan-item-card" data-title="{{ plan.title }}"> <!-- Add data-title for lookup -->
                            <div class="plan-item-header">
                                <div>
                                    <div class="plan-item-title">{{ plan.title }}</div>
                                    <div class="plan-item-date"><i class="fas fa-calendar"></i>{{ plan.start_date.strftime('%b %d') }} - {{ plan.end_date.strftime('%b %d, %Y') }}</div>
                                </div>
                                <span class="plan-item-status status-{{ plan.status }}">{{ plan.status|capitalize }}</span>
                            </div>
                            <div class="plan-item-details"><p>{{ plan.description }}</p></div>
                            <div class="plan-item-actions">
                                <a href="{{ url_for('edit_plan', plan_id=plan.id) }}" class="plan-action-btn edit"><i class="fas fa-edit"></i></a>
                                <form action="{{ url_for('delete_plan', plan_id=plan.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this plan?')">
                                    <button type="submit" class="plan-action-btn delete"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </div>
                        {% else %}
                        <p style="color: var(--text-secondary);">No training plans found. Click 'Add Plan' to create one.</p>
                        {% endfor %}
                    </div></div>
                </div>
            </div>
        </div>

        <div class="add-plan-modal" id="addPlanModal">
            <div class="modal-content"><div class="modal-header"><h3 class="modal-title">Create New Plan</h3><button class="close-modal">&times;</button></div><form action="{{ url_for('add_plan') }}" method="POST"><div class="form-group"><label>Plan Title</label><input type="text" name="title" placeholder="Enter plan title" required></div><div class="form-group"><label>Start Date</label><input type="date" name="start_date" required></div><div class="form-group"><label>End Date</label><input type="date" name="end_date" required></div><div class="form-group"><label>Plan Description</label><textarea name="description" placeholder="Describe your plan goals and activities" rows="4" required></textarea></div><div class="form-buttons"><button type="button" class="modal-btn cancel">Cancel</button><button type="submit" class="modal-btn save">Create Plan</button></div></form></div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const plansByDay = JSON.parse('{{ plans_for_js | safe }}');
            const todayISO = '{{ today_iso }}';

            // --- DYNAMIC TIMELINE GENERATION (IMPROVED) ---
            const timelineContainer = document.getElementById('timelineContainer');
            if (Object.keys(plansByDay).length > 0) {
                const allPlans = Object.values(plansByDay);
                const uniquePlans = [...new Map(allPlans.map(item => [item['title'], item])).values()];
                uniquePlans.sort((a, b) => new Date(a.start_date) - new Date(b.start_date));
                
                const dates = uniquePlans.flatMap(p => [new Date(p.start_date), new Date(p.end_date)]);
                const minDate = new Date(Math.min.apply(null, dates));
                const maxDate = new Date(Math.max.apply(null, dates));
                const totalDuration = maxDate - minDate;

                let lastPosition = -100;
                let alternateUp = true;

                uniquePlans.forEach(plan => {
                    const startDate = new Date(plan.start_date);
                    const durationFromStart = startDate - minDate;
                    let position = totalDuration > 0 ? (durationFromStart / totalDuration) * 100 : 50;
                    position = Math.max(5, Math.min(95, position));

                    let pointTop = '50%';
                    let labelTop = 'calc(50% + 25px)';

                    if (position - lastPosition < 12) { // Increased gap for collision
                        pointTop = alternateUp ? '30%' : '70%';
                        labelTop = alternateUp ? 'calc(30% - 40px)' : 'calc(70% + 25px)';
                        alternateUp = !alternateUp;
                    } else {
                        alternateUp = true;
                    }
                    
                    const point = document.createElement('div');
                    point.className = `timeline-point ${plan.status}`;
                    point.style.left = `${position}%`;
                    point.style.top = pointTop;
                    
                    const label = document.createElement('div');
                    label.className = 'timeline-label';
                    label.style.left = point.style.left;
                    label.style.top = labelTop;
                    label.textContent = plan.title;
                    
                    timelineContainer.appendChild(point);
                    timelineContainer.appendChild(label);
                    lastPosition = position;
                });
            }

            // --- DYNAMIC & INTERACTIVE CALENDAR GENERATION ---
            const calendarGrid = document.getElementById('planCalendarGrid');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayEl.dataset.date = dateStr;

                if (dateStr === todayISO) { dayEl.classList.add('today'); }
                
                const plan = plansByDay[dateStr];
                if (plan) {
                    dayEl.classList.add(plan.status); // 'completed', 'pending', or 'upcoming'
                } else {
                    dayEl.classList.add('no-plan');
                }
                calendarGrid.appendChild(dayEl);
            }

            calendarGrid.addEventListener('click', function(e) {
                const dayElement = e.target.closest('.calendar-day');
                if (!dayElement || dayElement.classList.contains('no-plan')) return;

                const dateStr = dayElement.dataset.date;
                const plan = plansByDay[dateStr];
                
                if (plan) {
                    const targetCard = document.querySelector(`.plan-item-card[data-title="${plan.title}"]`);
                    if (targetCard) {
                        // Scroll the card into view
                        targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        // Apply a temporary highlight
                        targetCard.classList.add('highlight');
                        setTimeout(() => {
                            targetCard.classList.remove('highlight');
                        }, 1500); // Highlight lasts for 1.5 seconds
                    }
                }
            });
            
            // --- MODAL LOGIC (Unchanged) ---
            const addPlanModal = document.getElementById('addPlanModal');
            const addPlanBtn = document.getElementById('addPlanBtn');
            const startDateInput = addPlanModal.querySelector('input[name="start_date"]');
            const endDateInput = addPlanModal.querySelector('input[name="end_date"]');
            const defaultStart = new Date();
            const defaultEnd = new Date();
            defaultEnd.setDate(defaultEnd.getDate() + 30);
            startDateInput.value = defaultStart.toISOString().split('T')[0];
            endDateInput.value = defaultEnd.toISOString().split('T')[0];
            const closeModal = () => { addPlanModal.style.display = 'none'; };
            addPlanBtn.addEventListener('click', () => { addPlanModal.style.display = 'flex'; });
            addPlanModal.querySelector('.close-modal').addEventListener('click', closeModal);
            addPlanModal.querySelector('.modal-btn.cancel').addEventListener('click', closeModal);
            addPlanModal.addEventListener('click', (e) => { if (e.target === addPlanModal) { closeModal(); } });
        });
    </script>
</body>
</html>
