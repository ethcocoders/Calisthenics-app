<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/videos.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
</head>
<body>
    <div class="container">
        {% include '_sidebar.html' %}

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Videos</h1>
                <div class="header-actions">
                    <button id="uploadVideoBtn"><i class="fas fa-upload"></i> Upload Video</button>
                </div>
            </div>

            <!-- Category Navigation -->
            <div class="categories-nav">
                <a href="{{ url_for('videos', category='all') }}" class="category-btn {{ 'active' if active_category == 'all' else '' }}">
                    <i class="fas fa-fire"></i> All Videos
                </a>
                {% for cat in categories %}
                <a href="{{ url_for('videos', category=cat) }}" class="category-btn {{ 'active' if active_category == cat else '' }}">
                    {% if cat == 'tutorial' %}<i class="fas fa-graduation-cap"></i>
                    {% elif cat == 'workout' %}<i class="fas fa-dumbbell"></i>
                    {% elif cat == 'progress' %}<i class="fas fa-chart-line"></i>
                    {% elif cat == 'motivation' %}<i class="fas fa-bolt"></i>
                    {% elif cat == 'competition' %}<i class="fas fa-trophy"></i>
                    {% endif %}
                    {{ cat.title() }}
                </a>
                {% endfor %}
            </div>

            <!-- Videos Grid -->
            <div class="videos-grid">
                {% for video in videos %}
                <div class="video-card">
                    <div class="video-thumbnail" data-video-id="{{ video.id }}" style="background-image: url('{{ url_for('static', filename=video.thumbnail_path) if video.thumbnail_path else '' }}');">
                        <div class="play-btn">
                            <i class="fas fa-play"></i>
                        </div>
                        {% if video.duration %}
                        <div class="video-duration">{{ video.duration }}</div>
                        {% endif %}
                    </div>
                    <div class="video-info">
                        <h3 class="video-title" data-video-id="{{ video.id }}">{{ video.title }}</h3>
                        <p class="video-description">{{ video.description or 'No description available.' }}</p>
                        <div class="video-meta">
                            <div class="video-stats">
                                <div class="stat-item" title="Size">
                                    <i class="fas fa-hdd"></i>
                                    <span>{{ '%.2f'|format(video.size_mb) if video.size_mb else 'N/A' }} MB</span>
                                </div>
                                <div class="stat-item" title="Upload Date">
                                    <i class="fas fa-calendar"></i>
                                    <span>{{ video.upload_date.strftime('%b %d, %Y') }}</span>
                                </div>
                            </div>
                            <div class="video-actions">
                                <form action="{{ url_for('delete_video', video_id=video.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to permanently delete this video?');">
                                    <button type="submit" class="action-btn delete" title="Delete Video">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <p style="text-align: center; color: var(--text-secondary); grid-column: 1 / -1;">No videos found. Click 'Upload Video' to add your first one!</p>
                {% endfor %}
            </div>
        </div>

        <!-- Video Player Modal -->
        <div class="video-player-modal" id="videoPlayerModal">
            <button class="close-player" id="closePlayer" title="Close player">&times;</button>
            <div class="video-player-content">
                <video id="videoPlayer" width="100%" controls controlsList="nodownload"></video>
                <div class="video-player-header">
                    <h3 class="video-player-title" id="playerTitle"></h3>
                    <p class="video-player-description" id="playerDescription"></p>
                </div>
            </div>
        </div>

        <!-- Upload Video Modal -->
        <div class="upload-modal" id="uploadVideoModal">
            <div class="upload-content">
                <form action="{{ url_for('upload_video') }}" method="POST" enctype="multipart/form-data">
                    <div class="upload-header">
                        <h3 class="upload-title">Upload New Video</h3>
                        <button type="button" class="close-upload" id="closeUpload">&times;</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoTitle">Video Title</label>
                        <input type="text" id="videoTitle" name="title" placeholder="e.g., My First Muscle Up" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoCategory">Category</label>
                        <select id="videoCategory" name="category" required>
                            <option value="" disabled selected>Select a category</option>
                            <option value="tutorial">Tutorial</option>
                            <option value="workout">Workout</option>
                            <option value="progress">Progress</option>
                            <option value="motivation">Motivation</option>
                            <option value="competition">Competition</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="videoDescription">Description</label>
                        <textarea id="videoDescription" name="description" placeholder="A short description of the video content."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Upload Video File</label>
                        <div class="file-drop" id="fileDropArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop your video file here</p>
                            <p>or click to browse</p>
                            <p><small>Supported formats: MP4, MOV, AVI (Max 500MB)</small></p>
                            <input type="file" id="videoFile" name="video_file" class="file-input" accept="video/*" required>
                        </div>
                    </div>
                    
                    <div class="upload-buttons">
                        <button type="button" class="upload-btn cancel" id="cancelUploadBtn">Cancel</button>
                        <button type="submit" class="upload-btn save">Upload Video</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // --- MODAL HANDLING ---
                const uploadVideoBtn = document.getElementById('uploadVideoBtn');
                const uploadVideoModal = document.getElementById('uploadVideoModal');
                const closeUploadBtn = document.getElementById('closeUpload');
                const cancelUploadBtn = document.getElementById('cancelUploadBtn');
                const videoPlayerModal = document.getElementById('videoPlayerModal');
                const closePlayerBtn = document.getElementById('closePlayer');

                if (uploadVideoBtn) {
                    uploadVideoBtn.addEventListener('click', () => uploadVideoModal.style.display = 'flex');
                }

                function closeUploadModal() {
                    uploadVideoModal.style.display = 'none';
                    uploadVideoModal.querySelector('form').reset();
                    resetFileDropUI();
                }

                if (closeUploadBtn) closeUploadBtn.addEventListener('click', closeUploadModal);
                if (cancelUploadBtn) cancelUploadBtn.addEventListener('click', closeUploadModal);
                if (uploadVideoModal) uploadVideoModal.addEventListener('click', e => {
                    if (e.target === uploadVideoModal) closeUploadModal();
                });

                // --- VIDEO PLAYER HANDLING ---
                const videoPlayer = document.getElementById('videoPlayer');
                const playerTitle = document.getElementById('playerTitle');
                const playerDescription = document.getElementById('playerDescription');

                document.querySelectorAll('.video-thumbnail, .video-title').forEach(el => {
                    el.addEventListener('click', async function() {
                        const videoId = this.dataset.videoId;
                        try {
                            const response = await fetch(`/videos/data/${videoId}`);
                            if (!response.ok) throw new Error('Network response was not ok');
                            const data = await response.json();
                            
                            playerTitle.textContent = data.title;
                            playerDescription.textContent = data.description;
                            videoPlayer.src = data.file_url;
                            
                            videoPlayerModal.style.display = 'flex';
                            videoPlayer.play();
                        } catch (error) {
                            console.error('Failed to fetch video data:', error);
                            alert('Could not load video data. Please try again.');
                        }
                    });
                });

                function closePlayer() {
                    videoPlayerModal.style.display = 'none';
                    videoPlayer.pause();
                    videoPlayer.src = ''; // Detach the source
                }

                if(closePlayerBtn) closePlayerBtn.addEventListener('click', closePlayer);
                if(videoPlayerModal) videoPlayerModal.addEventListener('click', e => {
                    if (e.target === videoPlayerModal) closePlayer();
                });

                // --- FILE UPLOAD UI HANDLING ---
                const fileDropArea = document.getElementById('fileDropArea');
                const videoFileInput = document.getElementById('videoFile');

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileDropArea.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    fileDropArea.addEventListener(eventName, () => fileDropArea.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    fileDropArea.addEventListener(eventName, () => fileDropArea.classList.remove('dragover'), false);
                });

                fileDropArea.addEventListener('click', () => videoFileInput.click());
                videoFileInput.addEventListener('change', handleFiles);
                fileDropArea.addEventListener('drop', e => handleFiles(e.dataTransfer.files));

                function handleFiles(files) {
                    const fileList = files.target ? files.target.files : files;
                    if (fileList.length > 0) {
                        videoFileInput.files = fileList;
                        const file = fileList[0];
                        fileDropArea.innerHTML = `
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            <p>File selected: ${file.name}</p>
                            <p><small>Click to change</small></p>
                        `;
                    }
                }

                function resetFileDropUI() {
                    fileDropArea.innerHTML = `
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag & drop your video file here</p>
                        <p>or click to browse</p>
                        <p><small>Supported formats: MP4, MOV, AVI (Max 500MB)</small></p>
                        <input type="file" id="videoFile" name="video_file" class="file-input" accept="video/*" required>
                    `;
                    // Re-bind listener after reset
                    document.getElementById('videoFile').addEventListener('change', handleFiles);
                }
            });
        </script>
</body>

</html>